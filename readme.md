# Create Django Workspace

Purpose is to set up a login and logout and register mechanism.

install Django version for the lesson.

'sudo pip3 install django==1.11.24'

# Create Django Project

'django-admin startproject django_auth .'

# Create Django App

'django-admin startapp accounts'

# Update Settings.py

Because we have add accounts app we need to update the settings.py

Add to Line 40 -> 'accounts'

# Creating a zshrc shortcut file

Thankfully I have now worked out how to do it on a Mac with .Zshrc

'echo alias vscode=\"/Applications/Visual\\ Studio\\ Code.app/contents/Resources/app/bin/code\" >> ~/.zshrc'

This will create a file in home directory, however the alias that you can create will work for many workspaces in VSCode :)

'alias vscode="/Applications/Visual\ Studio\ Code.app/contents/Resources/app/bin/code"
alias hi="echo hello world"
alias myconfig="nano ~/.zshrc"
alias run="python3 manage.py runserver"
alias migrate="python3 manage.py migrate"'

is what the file contains so far, dont forget to restart the terminal.

# Using shortcuts now

in the terminal

'migrate'
'run'

# Setting up other things

Creating hidden git ignore and env.py

'echo env.py .gitignore'
'echo import os >> env.py'

add this code to just below the import section in settings.py

'from os import path
if path.exists("env.py"):
  import env'

## Change Secret Key

and change the Secret Key (LINE 36)

'SECRET_KEY = os.environ.get('SECRET_KEY')'

KEY - can be generated by https://miniwebtool.com/django-secret-key-generator/

'os.environ["SECRET_KEY"] = "[KEY]"'

## Hostname

in env.py

'os.environ["HOSTNAME"] = "127.0.0.1"'

in settings.py (LINE 41)

'ALLOWED_HOSTS = [os.environ.get('HOSTNAME')]'

# Create Superuser

in the terminal

'python3 manage.py createsuperuser' 

I have created an alias in zshrc so you can type in 'creategod'

set user name, email and password.

# Admin Panel

goto hostname/admin

 and use the user and password

# Setting up Templates

in the accounts directory create a new folder called "templates"

inside the new folder create a file called
"index.html"

Create a basic html page,

'<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django Auth</title>
</head>

<body>
    <nav>
        <ul>
            <li><a href="#">Login</a></li>
            <li><a href="#">Logout</a></li>
            <li><a href="#">Register</a></li>
            <li><a href="#">Profile</a></li>
        </ul>
    </nav>
</body>

</html>'

## views.py

'def index(request):
    """ Return the index.html file """
    return render(request, 'index.html')'

## url.py

'from accounts.views import index'

in the urlpatters add

'url(r'^$', index),'

## Django Website

Should show you the 4 items we made in the index.html

# Create Logout

## index.html (LINE 14)

'<li><a href="{% url 'logout' %}">Logout</a></li>'

## urls.py

on LINE 18 modify this to 

'from accounts.views import index, logout'

on LINE 23 add

'url(r'^accounts/logout/$', logout, name="logout"),'

on LINE 22 modify it to this

'url(r'^$', index, name="index"),'

## views.py

to LINE 1 add the following

redirect and reverse

on LINE 2 add

'from django.contrib import auth'

on LINE 9 add

'def logout(request):
    """ Log the user out """
    auth.logout(request)
    return redirect(reverse('index'))
'

so the file at the moment should look like this 

'from django.shortcuts import render, redirect, reverse
from django.contrib import auth

# Create your views here.
def index(request):
    """ Return the index.html file """
    return render(request, 'index.html')

def logout(request):
    """ Log the user out """
    auth.logout(request)
    return redirect(reverse('index'))
'

# Django Messages

This will allow us to give feedback to the user.

## views.py

on LINE 2 add messages, so it looks like this
'from django.contrib import auth, messages'

on LINE 12 create this code
'messages.success(request, "You have successfully been logged out!")'

## index.html

below the </nav>

'<hr> {% if messages %}
    <div>
        {% for message in messages %} {{ message }} {% endfor %}
    </div>
    {% endif %}
'

Please note the <hr> (Horizontal Rule) is optional

## settings.py

add this to the bottom of the file

'MESSAGE_STORAGE = "django.contrib.messages.storage.session.SessionStorage"'

# Create Login

## views.py

add this to the bottom of the file

'def login(request):
    """ Return a login page """
    return render(request, 'login.html')'

## index.html

Insert a h1 to indentify what page is what.
So just below the opening body tag
'<h1>Home</h1>'

on LINE 14 change the href to 
'{% url 'login' %}'

## Create login.html

in accounts/templates

create a file called 'login.html'

copy the code from index.html into this file and modify LINE 11 to say
User Login instead of Home.

## urls.py

on LINE 24 add
'url(r'^accounts/login/$', login, name="login"),'

on LINE 18 add
'login' to the end of the line

# Create the login form

Create a forms.py in the accounts folder.

## forms.py

add this code to it
'from django import forms


class UserLoginForm(forms.Form):
    """Form to be used to log users in """
    username = forms.CharField()
    password = forms.CharField(widget=forms.PasswordInput)'

## views.py

add this code to LINE 3
'from accounts.forms import UserLoginForm'

add this code to LINE 18
'login_form = UserLoginForm()'

modify LINE 19, so that it can use the login  form
'return render(request, 'login.html', {"login_form": login_form})'

## login.html

on LINE 25 add this code
'    <form action="" method="POST">
        {{ login_form }}
    </form>'

# Authenticating Users

## login.html

Add a button to the login form, so it can submit.
Add this code to LINE 27
'<button type="submit">Login</button>'

This will fail when you try to click the submit button.

So on LINE 26,
add this code
'{% csrf_token %}'

So the form html should look like this.

'<form action="" method="POST">
        {% csrf_token %}
        {{ login_form }}
        <button type="submit">Login</button>
    </form>'

## views.py

Modify the def login to this.
'def login(request):
    """ Return a login page """
    if request.method == "POST":
        """ Create New Login Form """
        login_form = UserLoginForm(request.POST)
        """ Is the Form Valid? """
        if login_form.is_valid():
            user = auth.authenticate(username=request.POST['username'],
                                     password=request.POST['password'])

            if user:
                auth.login(user=user, request=request)
                messages.success(request, "You have successfully logged in!")
            else:
                login_form.add_error(None, "Your username or password is invalid!")
    else:
        login_form = UserLoginForm()
    return render(request, 'login.html', {"login_form": login_form})
    '

# Reducing the Code we are using

Create a folder in the root folder
In that folder create a file called base.html

## Base.html

'
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block page_title %}{% endblock %}</title>
</head>

<body>
    <h1>{% block page_heading %}{% endblock %}</h1>

    <nav>
        <ul>
            <li><a href="{% url 'login' %}">Login</a></li>
            <li><a href="{% url 'logout' %}">Logout</a></li>
            <li><a href="#">Register</a></li>
            <li><a href="#">Profile</a></li>
        </ul>
    </nav>
    <hr> {% if messages %}
    <div>
        {% for message in messages %} {{ message }} {% endfor %}
    </div>
    {% endif %} {% block content %}{% endblock %}

</body>

</html>
'

## index.html
'
{% extends 'base.html' %}

{% block page_title %}Home Page{% endblock %}

{% block page_heading %}Home{% endblock %}

{% block content %}{% endblock %}'

## settings.py

You will need to modify this LINE 71, because the base.html is not in the same folder as the other templates.
'
'DIRS': [os.path.join(BASE_DIR, 'templates')],
'

## login.html
'
{% extends 'base.html' %} 
{% block page_title %}Login Page{% endblock %}
{% block page_heading %}User Login{% endblock %}
{% block content %}
<form action="" method="POST">
    {% csrf_token %} {{ login_form }}
    <button type="submit">Login</button>
</form>
{% endblock %}
'

# Check to see if user already logged in

## base.html

modify the nav, unordered list to LINE 15

'
{% if user.is_authenticated %}
            <li><a href="#">Profile</a></li>
            <li><a href="{% url 'logout' %}">Logout</a></li>
            {% else %}
            <li><a href="{% url 'login' %}">Login</a></li>
            <li><a href="#">Register</a></li>
            {% endif %}
'

# Login Required

## views.py

Create this on LINE 29. this returns them to the index page on a successful login.
'
return redirect(reverse('index'))
'

Create on LINE 23, this checks to see if a user is logged in and automatically moves them to index page

'
if request.user.is_authenticated:
        return redirect(reverse('index'))
'

So the login function should look like this 
'
def login(request):
    """ Return a login page """
    if request.user.is_authenticated:
        return redirect(reverse('index'))

    if request.method == "POST":
        """ Create New Login Form """
        login_form = UserLoginForm(request.POST)
        """ Is the Form Valid? """
        if login_form.is_valid():
            user = auth.authenticate(username=request.POST['username'],
                                     password=request.POST['password'])

            if user:
                auth.login(user=user, request=request)
                messages.success(request, "You have successfully logged in!")
                return redirect(reverse('index'))
            else:
                login_form.add_error(None, "Your username or password is invalid!")
    else:
        login_form = UserLoginForm()
    return render(request, 'login.html', {"login_form": login_form})
'

# Logout only logged in users

## views.py

on LINE 3 insert this code
'
from django.contrib.auth.decorators import login_required
'

before the logout function add this line of code, should be LINE 11
'
@login_required
'

# Create Registration

## views.py

On LINE 41 create registration function
'
def registration(request):
    """ Render the registration page """
    return render(request, 'registration.html')
'

## urls.py

on LINE 25 add
'
url(r'^accounts/register/$', registration, name="registration"),
'

on LINE 18 add
'registration' to the end of the line

## base.html

LINE 20, change the href to
'registration'

## registration.html

Create this file and populate with
'
{% extends 'base.html' %} 
{% block page_title %}Registration Page{% endblock %}
{% block page_heading %}User Registration{% endblock %} 
{% block content %}
<p>If you already have an account, you can
    <a href="{% url 'login' %}">Sign In</a>
</p>
{% endblock %}'

# Create User Register Form

This is more indepth then the basic user form that was created before.

## forms.py

on LINE 2 add this code to the next few lines.

'
from django.contrib.auth.models import User
from django.contrib.auth.forms import UserCreationForm
from django.core.exceptions import ValidationError
'

on LINE 11 create a new class
'
class UserRegistrationForm(UserCreationForm):
    """ Form used to register a new user """

    password1 = forms.CharField(widget=forms.PasswordInput)
    password2 = forms.CharField(
        label="Password Confirmation", 
        widget=forms.PasswordInput)
    
    class Meta:
        model = User
        fields = ['email', 'username', 'password1', 'password2']

'

## views.py

Go back to LINE 4 and add 'UserRegistrationForm' after UserLoginForm

So it should look like this
'
from accounts.forms import UserLoginForm, UserRegistrationForm
'

On LINE 41 under the registration function, add the LINE 43,

'
registration_form = UserRegistrationForm()
'

On LINE 44 add
', {"registration_form": registration}'

It should look like this
'
def registration(request):
    """ Render the registration page """
    registration_form = UserRegistrationForm()
    return render(request, 'registration.html', {
            "registration_form": registration_form})
'

## registration.html

Add the following code to the CONTENT BLOCK, below the end paragraph tag

'
<form action="" method="POST">
    {% csrf_token %} {{ registration_form }}
    <button type="submit">Register
    </button>
</form>
'

# Displaying a better form

If you goto the browser and refresh the registration page, there is a form but it looks bad.

## regisration.html

Modify the 
'{{ registration_form }}'
as it now says 
'{{ registration_form.as_p }}'

This puts each field on a new row.

As you can see it now states that password1, so I have added a label to it in forms.py LINE 15 

# Form Validation

## forms.py

below the Meta CLASS, insert this code.

'
 def clean_email(self):
        email = self.cleaned_data.get('email')
        username = self.cleaned_data.get('username')
        if User.objects.filter(email=email).exclude(username=username):
            raise forms.ValidationError(u'Email address must be unique')
        return email

    def clean_password2(self):
        password1 = self.cleaned_data.get('password1')
        password2 = self.cleaned_data.get('password2')

        if not password1 or not password2:
            raise ValidationError("Please confirm your password!")

        if password1 != password2:
            raise ValidationError("Passwords must match")
        return password2
'

# Storing the User Information to Create a New User

At present the registration for is not linked upto anything to fix this,

# view,py

Change the registration function to this.

'
def registration(request):
    """ Render the registration page """
    if request.user.is_authenticated:
        return redirect(reverse('index'))

    if request.method == "POST":
        registration_form = UserRegistrationForm(request.POST)

        if registration_form.is_valid():
            registration_form.save()

            user = auth.authenticate(username=request.POST['username'],
                                     password=request.POST['password1'])
            
            if user:
                auth.login(user=user, request=request)
                messages.success(request, "You have successfully registered")
                return redirect(reverse('index'))
            else:
                messages.error(request, "Unable to register at this time")
    else:
        registration_form = UserRegistrationForm()
    return render(request, 'registration.html', {
            "registration_form": registration_form})

'

# User Profile

## views.py

on LINE 66 add the following code,

'
def user_profile(request):
    """ The users profile page """
    user = User.objects.get(email=request.user.email)
    return render(request, 'profile.html', {"profile": user})
'

## urls.py

Add 'profile' to the end of LINE 18

LINE 18 should now look like

'
from accounts.views import index, logout, login, registration, user_profile
'

add another urlpattern as

'
    url(r'^accounts/profile/$', user_profile, name="profile"),
'

## base.html

LINE 16 the profile nav tag should have its href updated, so it looks like this.

'
<li><a href="{% url 'profile' %}">Profile</a></li>
'

## profile.html

Create this file by copying the index.html

modify so it looks like this.

'
{% extends 'base.html' %} 
{% block page_title %}{{ user }}'s Profile{% endblock %} 
{% block page_heading %}{{ user }}'s Profile{% endblock %}
{% block content %}<p>{{ user.email}}</p>{% endblock %}
'

## views.py

There is an error so you need to add this code to LINE 4

'from django.contrib.auth.models import User
'

# Reseting Passwords

## url_reset.py

Create a file and populate with this code.

'
from django.conf.urls import url
from django.core.urlresolvers import reverse_lazy
from django.contrib.auth.views import password_reset, password_reset_done, password_reset_confirm, password_reset_complete

urlpatterns = [
    url('^$', password_reset, {'post_reset_redirect': reverse_lazy('password_reset_done')}, name='password_reset'),
    url(r'^done/$', password_reset_done, name='password_reset_done'),
    url(r'^(?P<uidb64>[0-9A-Za-z]+)-(?P<token>.+)/$', password_reset_confirm,
        {'post_reset_redirect': reverse_lazy('password_reset_complete')}, name='password_reset_confirm'),
    url('^complete/$', password_reset_complete, name='password_reset_complete')
]
'

# Create urls.py inside accounts folder

This will allow us to keep our accounts url and code together.

Add the Following code,

LINE 1
'from django.conf.urls import url, include'

LINE 2 - cut the code from LINE 18 or urls.py in django_auth
'from accounts.views import index, logout, login, registration, user_profile'

LINE 3
'from accounts import url_reset'

LINE 5

'urlpatterns = [


]

LINE 6 - cut the code from LINE 24 (Basically all the code we have input) and paste it into LINE 6

Remove all the words that say "accounts/" in the urlpatterns because we have refenced them already.

LINE 10
'url(r'^password-reset/', include(url_reset))'

<<dont include dollar sign if importing>>

The File should look like this
'from django.conf.urls import url, include
from accounts.views import index, logout, login, registration, user_profile
from accounts import url_reset

urlpatterns = [
    url(r'^logout/', logout, name="logout"),
    url(r'^login/', login, name="login"),
    url(r'^register/', registration, name="registration"),
    url(r'^profile/', user_profile, name="profile"),
    url(r'^password-reset/', include(url_reset))
]
'

## urls.py (django_auth)

LINE 18
'from accounts import urls as accounts_urls'

LINE 16 - add to the end of the line
', include'

LINE 23
'url(r'^accounts/', include(accounts_urls))'

LINE 18
'from accounts.views import index'

# Setting up Emails

## settings.py

Add to the bottom of the file, this will output the email to the console.

'EMAIL_BACKEND = "django.core.email.backends.console.EmailBackend"'

# Wiring up the Reset Password Templates

In our Root Templates folder, where the base.html is kept.

Create a new folder called 

'registration'

and in that folder create a file called

'password_reset_form.html'

## password_reset_form.html

'{% extends 'base.html' %} {% block page_title %}Password Reset Page{% endblock %} {% block page_heading %}Reset Password{% endblock %} {% block content %}
<form action="" method="POST">
    <p>Please enter your email address</p>

    {% csrf_token %} {{ form.email.errors }}

    <p><label for="id_email">Email address:</label> {{ form.email }}

        <button>Reset Password</button>
    </p>
</form>
{% endblock %}
'

## login.html

LINE 7 - 9 added.
'<p>
    <a href="{% url 'password_reset' %}">Reset Password</a>
</p>
'

### Additional Work Later

Create templates for password_reset_email.html, password_reset_done.html, password_reset_complete.html and password_reset_confirm.html The password_reset_confirm.html template will require a form that the user will input their new password into. This form can be accessed using {{ form }} and contains password1 and password2 fields.

# Sending a Real Email

## settings.py

remove LINE 138 and replace with

'EMAIL_USE_TLS = True
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_HOST_USER = os.environ.get("EMAIL_ADDRESS")
EMAIL_HOST_PASSWORD = os.environ.get("EMAIL_PASSWORD")
EMAIL_PORT = 587'

## env.py

add the EMAIL_ADDRESS and EMAIL_PASSWORD to the list.

# Custom Authentication Backend

## settings.py

Under the AUTH_PASSWORD_VALIDATORS

insert this code.

'
AUTHENTICATION_BACKENDS = [
    'django.contrib.auth.backends.ModelBackend',
    'accounts.backends.EmailAuth'
]
'

## backends.py

Create this file in the "Accounts" folder.

Add the following code 

'
from django.contrib.auth.models import User


class EmailAuth:
    """ Authenticate a user by an exact match on the email and password """

    def authenticate(self, username=None, password=None):
        """ Get an instance of 'User' based off the email and verify the password """

        try:
            user = User.objects.get(email=username)

            if user.check_password(password):
                return user
            return None
        except User.DoesNotExist:
            return None

    def get_user(self, user_id):
        """ Used by the Django authentication system to retrieve a user instance """


        try:
            user = User.objects.get(pk=user_id)

            if user.is_active:
                return user
            return None
        except User.DoesNotExist:
            return None
'

# Styling With BootStrap

## base.py

Add this to the HEAD Element, its bootstrap 3.3.7

'
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
'

Add some classes to the nav and ul
'   <nav class="navbar navbar-default">
        <ul class="nav navbar-nav">
'

Also move the H1 down below the Navbar.


# Bootstrapping Forms

Use 'sudo pip3 install django_forms_bootstrap'

to install custom django forms for bootstrap.

## settings.py

Add the following LINE to INSTALLED_APPS

'
'django_forms_bootstrap',
'

## registration.html

Add this block to just after the extends base.html block

'{% load bootstrap_tags%}'

Add a class to the submit button

'<button type="submit" class="btn btn-default">Register
    </button>'

Change the {{ registration_form}} to

'{{ registration_form | as_bootstrap }}
'

## login.html

Add this block to just after the extends base.html block

'{% load bootstrap_tags%}'

Add a class to the submit button

'<button type="submit" class="btn btn-default">Login
    </button>'

Change the {{ login_form }} to

'{{ login_form | as_bootstrap }}
'

# Custom CSS Code

Create in top level folder

Folder called 'static'
in that folder, create another one called 'css'

and in that one create a file called 'styles.css'

## base.html

At the top of the file add the code '{% load staticfiles %}' above the html tag.

Add the following code to just below the HEAD Tag

<!-- Custom CSS-->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    

## settings.py

Add the following code to just a LINE below STATIC_URL
'
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, "static")
]
'

## styles.css

'form {
    width: 50%;
}'